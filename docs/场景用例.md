# 场景用例

## 市价单相关

- **一次性全部成交**：状态变更为 `FILLED`，立即发送卡片，字段包含交易对、状态=市价成交、Size（原下单数量）、累计成交量（等于 Size）、平均成交价格、通知时间。
- **分批成交且 10 秒内全部完成**：首次部分成交触发 10 秒聚合窗口；窗口内收集到的成交合并后达到 `FILLED`，按一次性成交处理并发送一条卡片，累计成交量为合并后的成交总量。
- **分批成交但 10 秒内无新增成交**：等待期满仍未补充成交，按当前累计成交量和加权均价发送卡片，状态保持市价成交；若后续再次出现成交，重新开启新的 10 秒窗口并再次发送。

## SL/TP 订单（限价或其他类型）

- **客户端订单号不以 `SL`/`TP` 开头**：全部状态变更忽略，不发送通知。
- **创建 (`NEW`)**：捕获创建事件，发送卡片，字段包含交易对、状态=创建、Size（原下单数量）、价格（挂单价）、通知时间。
- **取消 (`CANCELED`)**：捕获取消事件，发送卡片，字段包含交易对、状态=取消、Size（原下单数量或剩余挂单量）、价格（挂单价）、通知时间。
- **完全成交 (`FILLED`)**：发送卡片，字段包含交易对、状态=成交、Size（原下单数量）、累计成交量（等于 Size）、价格（平均成交价）、通知时间。
- **部分成交且 10 秒内完成**：首次部分成交启动 10 秒聚合；若窗口内全部成交，合并后发送卡片，状态=成交，累计成交量为总成交量，价格为加权平均成交价。
- **部分成交但 10 秒内未补足**：等待期满后发送卡片，状态建议统一为成交（或明确标记为部分成交，需在实现中确定），累计成交量为当前累计值，价格取对应的成交均价。若之后继续成交，再次进入 10 秒窗口并发送新的卡片。
- **部分成交后取消**：在 10 秒窗口内如出现取消事件，合并已收集信息，最终卡片状态=取消，累计成交量为已成交数量，Size 可保留原下单量，价格根据需求选择平均成交价或挂单价并保持全局一致。

## 共通逻辑

- 卡片消息通过飞书机器人 webhook `https://open.feishu.cn/open-apis/bot/v2/hook/caebac89-0213-4c14-add8-d4681f138245` 推送。
- 卡片字段命名固定为：交易对、状态、Size、累计成交量（仅成交类场景）、价格或平均成交价格、通知时间。
- 对于 10 秒聚合窗口，需在首次部分成交时启动计时器，期间合并同一订单的后续成交或终态事件，并依据最终状态选择合适的文案与字段数据。
