# 场景用例

## TP/SL/FT 订单（限价或其他类型）

- **订单识别与来源**：
  - 客户端订单号以 `TP` 开头 → 来源 = `止盈`；其中 `TP1` → 标题 `{交易对} - 反弹1/5减仓`，`TP2` → 标题 `{交易对} - 反弹1/2清仓`，其他 `TP*` → 标题 `{交易对} - 止盈`。
  - 客户端订单号以 `SL` 开头 → 来源 = `止损`；成交或终态标题为 `{交易对} - 5%成本止损`。
  - 客户端订单号以 `FT` 开头 → 来源 = `追踪止损`，标题强制设为 `{交易对} - 跟踪交易止损`（优先级高于 `TP`/`SL` 规则）。
  - 不以上述前缀开头 → 来源 = `其他`，归为普通订单，见下节。
- **创建 (`NEW`)**：无聚合，收到即发；卡片标题按前缀规则，状态=创建，价格=挂单价，金额字段默认 0 或基于下单信息初始化。
- **取消 (`CANCELED`)**：无聚合，收到即发；若此前存在成交记录需带上累计成交金额、占比、PnL；标题按前缀规则。
- **完全成交 (`FILLED`)**：无聚合窗口；首次终态或聚合结束直接发送，标题依前缀规则选择（`FT` > `TP1`/`TP2` > 其他 `TP` > `SL`）。
- **部分成交**：
  - 首次出现部分成交时开启 10 秒聚合窗口，仅在聚合期间收集同一订单的追加成交或取消事件。
  - 窗口内若累计成交量达到订单总量 → 发送状态=成交；窗口超时仍未完全成交 → 状态=部分成交；后续新增成交重新开窗。
  - 若窗口内出现取消事件 → 立即合并已成交信息并发送，状态=取消。
  - 聚合输出的标题及字段均遵循上述规则，金额类字段基于聚合后的累计值计算。

## 普通订单（非 TP/SL/FT）

- **来源字段**：统一设置为 `其他`，标题 `{交易对} - 其他`。
- **创建 (`NEW`) / 取消 (`CANCELED`)**：继续按现有逻辑即时推送。
- **完全成交 (`FILLED`)**：若无历史部分成交，收到终态即发；否则由部分成交聚合窗口统一输出。
- **部分成交聚合**：首次部分成交启动 10 秒窗口，窗口内补足成交则输出状态=成交，否则超时输出状态=部分成交；后续新增成交按新窗口处理；若窗口内取消则状态=取消。

## 共通逻辑

- 卡片消息通过主要飞书 webhook `https://open.feishu.cn/open-apis/bot/v2/hook/caebac89-0213-4c14-add8-d4681f138245` 推送；当状态为“创建”或“取消”时，同步推送至备用 webhook `https://open.feishu.cn/open-apis/bot/v2/hook/2b097171-60ad-476e-ae90-a78e301bb791`。
- 卡片标题优先级：`FT*` > `TP1`/`TP2` > 其他 `TP*` > `SL*` > 默认来源标题；聚合前后保持一致。
- 卡片字段统一调整：移除 `Size`、`累计成交量`；新增 `累计成交金额`、`累计成交金额占比`、`该笔交易累计 PnL`；保留交易对、方向、来源、状态、价格/平均成交价、通知时间及聚合说明。
- 金额、占比、PnL 在每次推送前按最新累计数据计算：
  - `累计成交金额` = 加权平均成交价 × 累计成交量。
  - `累计成交金额占比` = `累计成交金额` ÷ 账户总资金（以账户权益或可用资金为基准，需在实现时明确并保持一致）。
  - `该笔交易累计 PnL` = 累加事件中的 `rp`（已实现盈亏），若字段缺失则显示 `0` 或 `-` 并记录告警。
- 对于 10 秒聚合窗口，需在首次部分成交时启动计时器，期间合并同一订单的后续成交或终态事件，并依据最终状态选择文案与字段数据；聚合结束后清理窗口状态。

## 币安持仓校验

### 多空币种名单（重构版）

- **默认无限制**：当多头/空头白名单为空时，可持有任意基础币种；黑名单为空则不做拦截。
- **多头白名单**：配置白名单（如 `{BTC, ETH}`）后，持有白名单之外的多头仓位（如 SOLUSDT）即触发告警；白名单非空但当前无多头仓位视为合规。
- **空头白名单**：配置白名单（如 `{BTC}`）后，持有其他空头仓位（如 BNBUSDT）触发告警；同一基础币种多空双向持仓时分别校验。
- **多头黑名单**：列入黑名单的多头仓位（如 `{DOGE, PEPE}`）出现即告警；白名单为空时黑名单等价于“禁止列表”。
- **空头黑名单**：列入黑名单的空头仓位（如 `{BTC}`）出现即告警，与白名单组合时分别生效。
- **默认 + 覆盖**：默认规则适用于所有币种，某基础币种可通过覆盖配置调整白/黑名单；覆盖为空数组表示该方向无限制。
- **配置异常**：白名单与黑名单冲突、格式错误等需产出配置异常告警。
- **无持仓**：账户无多/空仓位时仅保留配置异常（若有），不会因为白名单非空而告警。

### 杠杆限制

- 默认杠杆阈值（如 ≤3 倍）内的持仓视为通过。
- 超过默认阈值的持仓触发告警。
- 币种覆盖可放宽阈值（如 BTC ≤10 倍）或收紧阈值（如某币 ≤1 倍）；仅当超出对应覆盖阈值时告警。
- 多空方向共用同一杠杆阈值，双向持仓需要分别验证。
- 缺少杠杆数据或未找到配置时输出配置/数据异常。

### 单币种保证金占比

- 以账户总保证金为基准计算单币种保证金占比。
- 默认阈值场景：占比低于阈值（如 3% < 5%）通过，超过阈值（如 6% > 5%）告警。
- 币种覆盖可提高（如 BTC ≤50%）或降低阈值（如某币 ≤1%）；超过对应阈值时告警。
- 多空方向共用同一阈值，双向持仓需分别检查并合并结果。
- 若总保证金数据缺失或为零，视为数据异常并告警。

### 总保证金使用率

- 所有持仓保证金总和低于 100% 时通过。
- 使用率等于 100% 的边界行为需在实现中明确（例如视为通过或生成提示告警）。
- 使用率超过 100%（如 110%）时触发告警。
- 计算所需的保证金数据缺失或异常时返回数据异常告警。

### 资费利率（下一次预估值）

- 默认空头资费阈值（如 ≥-0.2%）：下一次预估资费率高于或等于阈值时通过。
- 预估资费率低于默认阈值（如 -0.23%）时对相应方向持仓告警。
- 币种覆盖可放宽阈值（如某币空头 ≥-0.1%）或收紧阈值（设为正值等）；低于覆盖阈值立刻告警。
- 若多头方向也配置阈值，需按方向分别校验下一次预估资费率。
- 资费率数据缺失或方向阈值缺省时输出配置/数据异常。

### 组合与异常场景

- 同一基础币种可能同时违反多个规则（如杠杆与保证金），需返回全部告警项。
- 多空双向持仓需确保每条规则对两个方向独立判定并汇总结果。
- 遇到未知币种、配置缺项或格式错误时提供诊断提示，避免静默失败。
- 当持仓数量较多时，需要验证遍历性能并在超时或响应超限时降级处理。
