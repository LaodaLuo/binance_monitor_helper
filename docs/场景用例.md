# 场景用例

## SL/TP 订单（限价或其他类型）

- **客户端订单号不以 `SL`/`TP` 开头**：全部状态变更忽略，不发送通知。
- **来源字段**：
  - 客户端订单号以 `TP` 开头 → 来源 = `止盈`。
  - 客户端订单号以 `SL` 开头 → 来源 = `止损`。
- **创建 (`NEW`)**：捕获创建事件，发送卡片；字段包含交易对、方向、来源、状态=创建、Size（原下单数量）、价格（挂单价）、通知时间。
- **取消 (`CANCELED`)**：捕获取消事件；字段包含交易对、方向、来源、状态=取消、Size（原下单数量或剩余挂单量）、价格（挂单价）、通知时间。
- **完全成交 (`FILLED`)**：捕获终态成交；字段包含交易对、方向、来源、状态=成交、Size（原下单数量）、累计成交量（等于 Size）、价格（平均成交价）、通知时间。
- **部分成交且 10 秒内完成**：首次部分成交启动 10 秒聚合；若窗口内全部成交，合并后发送卡片，状态=成交，累计成交量为总成交量，价格为加权平均成交价。
- **部分成交但 10 秒内未补足**：等待期满后发送卡片，状态统一为部分成交（或成交，保持实现一致），累计成交量为当前累计值，价格取对应成交均价。若之后继续成交，再次进入新窗口并发送新的卡片。
- **部分成交后取消**：在 10 秒窗口内出现取消事件时合并已收集信息，最终状态=取消，累计成交量为已成交数量，Size 保留原下单量，价格可选用平均成交价或挂单价（需在实现中保持一致）。

## 普通订单（非 SL/TP）

- **来源字段**：统一设置为 `其他`。
- **监听范围**：所有客户端订单号不以 `SL`/`TP` 开头的订单；不再区分市价单或限价单。
- **一次性全部成交**：状态首次变更为 `FILLED` 且无历史部分成交，立即发送通知；字段包含交易对、方向、来源=其他、状态=成交、Size、累计成交量、平均成交价格、通知时间。
- **分批成交且 10 秒内全部完成**：首次部分成交触发 10 秒聚合窗口；窗口内追加成交直至 `FILLED`，合并 Size 与均价后发送同一条通知。
- **分批成交但 10 秒内无新增成交**：等待期满仍未补充成交，按当前累计成交量与加权均价发送通知，状态保持为成交或部分成交（实现需统一）。若后续再出现成交，重新开启新的 10 秒窗口并重复上述流程。
- **部分成交后取消**：窗口内如出现 `CANCELED`，合并已收集信息后发送通知，状态=取消，累计成交量为已成交数量。

## 共通逻辑

- 卡片消息通过主要飞书机器人 webhook `https://open.feishu.cn/open-apis/bot/v2/hook/caebac89-0213-4c14-add8-d4681f138245` 推送；当状态为“创建”或“取消”时，同步推送至备用 webhook `https://open.feishu.cn/open-apis/bot/v2/hook/2b097171-60ad-476e-ae90-a78e301bb791`。
- 卡片标题显示为 `交易对-来源`；正文字段包含方向、状态、Size、累计成交量（仅成交类场景）、价格/平均成交价格、通知时间。
- 对于 10 秒聚合窗口，需在首次部分成交时启动计时器，期间合并同一订单的后续成交或终态事件，并依据最终状态选择合适的文案与字段数据。
