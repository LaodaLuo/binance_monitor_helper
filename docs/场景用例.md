# 场景用例

## SL/TP 订单（限价或其他类型）

- **客户端订单号不以 `SL`/`TP` 开头**：全部状态变更忽略，不发送通知。
- **来源字段**：
  - 客户端订单号以 `TP` 开头 → 来源 = `止盈`。
  - 客户端订单号以 `SL` 开头 → 来源 = `止损`。
- **创建 (`NEW`)**：捕获创建事件，发送卡片；字段包含交易对、方向、来源、状态=创建、Size（原下单数量）、价格（挂单价）、通知时间。
- **取消 (`CANCELED`)**：捕获取消事件；字段包含交易对、方向、来源、状态=取消、Size（原下单数量或剩余挂单量）、价格（挂单价）、通知时间。
- **完全成交 (`FILLED`)**：捕获终态成交；字段包含交易对、方向、来源、状态=成交、Size（原下单数量）、累计成交量（等于 Size）、价格（平均成交价）、通知时间。
- **部分成交且 10 秒内完成**：首次部分成交启动 10 秒聚合；若窗口内全部成交，合并后发送卡片，状态=成交，累计成交量为总成交量，价格为加权平均成交价。
- **部分成交但 10 秒内未补足**：等待期满后发送卡片，状态统一为部分成交（或成交，保持实现一致），累计成交量为当前累计值，价格取对应成交均价。若之后继续成交，再次进入新窗口并发送新的卡片。
- **部分成交后取消**：在 10 秒窗口内出现取消事件时合并已收集信息，最终状态=取消，累计成交量为已成交数量，Size 保留原下单量，价格可选用平均成交价或挂单价（需在实现中保持一致）。

## 普通订单（非 SL/TP）

- **来源字段**：统一设置为 `其他`。
- **监听范围**：所有客户端订单号不以 `SL`/`TP` 开头的订单；不再区分市价单或限价单。
- **一次性全部成交**：状态首次变更为 `FILLED` 且无历史部分成交，立即发送通知；字段包含交易对、方向、来源=其他、状态=成交、Size、累计成交量、平均成交价格、通知时间。
- **分批成交且 10 秒内全部完成**：首次部分成交触发 10 秒聚合窗口；窗口内追加成交直至 `FILLED`，合并 Size 与均价后发送同一条通知。
- **分批成交但 10 秒内无新增成交**：等待期满仍未补充成交，按当前累计成交量与加权均价发送通知，状态保持为成交或部分成交（实现需统一）。若后续再出现成交，重新开启新的 10 秒窗口并重复上述流程。
- **部分成交后取消**：窗口内如出现 `CANCELED`，合并已收集信息后发送通知，状态=取消，累计成交量为已成交数量。

## 共通逻辑

- 卡片消息通过主要飞书机器人 webhook `https://open.feishu.cn/open-apis/bot/v2/hook/caebac89-0213-4c14-add8-d4681f138245` 推送；当状态为“创建”或“取消”时，同步推送至备用 webhook `https://open.feishu.cn/open-apis/bot/v2/hook/2b097171-60ad-476e-ae90-a78e301bb791`。
- 卡片标题显示为 `交易对-来源`；正文字段包含方向、状态、Size、累计成交量（仅成交类场景）、价格/平均成交价格、通知时间。
- 对于 10 秒聚合窗口，需在首次部分成交时启动计时器，期间合并同一订单的后续成交或终态事件，并依据最终状态选择合适的文案与字段数据。

## 币安持仓校验

### 多空币种名单（重构版）

- **默认无限制**：当多头/空头白名单为空时，可持有任意基础币种；黑名单为空则不做拦截。
- **多头白名单**：配置白名单（如 `{BTC, ETH}`）后，持有白名单之外的多头仓位（如 SOLUSDT）即触发告警；白名单非空但当前无多头仓位视为合规。
- **空头白名单**：配置白名单（如 `{BTC}`）后，持有其他空头仓位（如 BNBUSDT）触发告警；同一基础币种多空双向持仓时分别校验。
- **多头黑名单**：列入黑名单的多头仓位（如 `{DOGE, PEPE}`）出现即告警；白名单为空时黑名单等价于“禁止列表”。
- **空头黑名单**：列入黑名单的空头仓位（如 `{BTC}`）出现即告警，与白名单组合时分别生效。
- **默认 + 覆盖**：默认规则适用于所有币种，某基础币种可通过覆盖配置调整白/黑名单；覆盖为空数组表示该方向无限制。
- **配置异常**：白名单与黑名单冲突、格式错误等需产出配置异常告警。
- **无持仓**：账户无多/空仓位时仅保留配置异常（若有），不会因为白名单非空而告警。

### 杠杆限制

- 默认杠杆阈值（如 ≤3 倍）内的持仓视为通过。
- 超过默认阈值的持仓触发告警。
- 币种覆盖可放宽阈值（如 BTC ≤10 倍）或收紧阈值（如某币 ≤1 倍）；仅当超出对应覆盖阈值时告警。
- 多空方向共用同一杠杆阈值，双向持仓需要分别验证。
- 缺少杠杆数据或未找到配置时输出配置/数据异常。

### 单币种保证金占比

- 以账户总保证金为基准计算单币种保证金占比。
- 默认阈值场景：占比低于阈值（如 3% < 5%）通过，超过阈值（如 6% > 5%）告警。
- 币种覆盖可提高（如 BTC ≤50%）或降低阈值（如某币 ≤1%）；超过对应阈值时告警。
- 多空方向共用同一阈值，双向持仓需分别检查并合并结果。
- 若总保证金数据缺失或为零，视为数据异常并告警。

### 总保证金使用率

- 所有持仓保证金总和低于 100% 时通过。
- 使用率等于 100% 的边界行为需在实现中明确（例如视为通过或生成提示告警）。
- 使用率超过 100%（如 110%）时触发告警。
- 计算所需的保证金数据缺失或异常时返回数据异常告警。

### 资费利率（下一次预估值）

- 默认空头资费阈值（如 ≥-0.2%）：下一次预估资费率高于或等于阈值时通过。
- 预估资费率低于默认阈值（如 -0.23%）时对相应方向持仓告警。
- 币种覆盖可放宽阈值（如某币空头 ≥-0.1%）或收紧阈值（设为正值等）；低于覆盖阈值立刻告警。
- 若多头方向也配置阈值，需按方向分别校验下一次预估资费率。
- 资费率数据缺失或方向阈值缺省时输出配置/数据异常。

### 组合与异常场景

- 同一基础币种可能同时违反多个规则（如杠杆与保证金），需返回全部告警项。
- 多空双向持仓需确保每条规则对两个方向独立判定并汇总结果。
- 遇到未知币种、配置缺项或格式错误时提供诊断提示，避免静默失败。
- 当持仓数量较多时，需要验证遍历性能并在超时或响应超限时降级处理。
